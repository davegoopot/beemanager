name: Deploy to Private Repo
env:
  GITHUB_TOKEN:  ${{ secrets.DEPLOY_TOKEN }}

on:
  workflow_dispatch: 
  push: 
    branches: [ main ]

jobs:
  deploy: 
    runs-on: ubuntu-latest
    steps:
    - name:  Checkout code
      uses: actions/checkout@v2

    - name: Debug - Check token presence
      run: |
        if [ -z "$GITHUB_TOKEN" ]; then
          echo "ERROR: GITHUB_TOKEN is empty or not set"
          exit 1
        else
          echo "GITHUB_TOKEN is set (length:  ${#GITHUB_TOKEN})"
        fi

    - name:  Debug - Test authentication and extract clone token
      run:  |
        echo "Testing authentication to target repo..."
        response=$(curl -s -w "\n%{http_code}" \
             -H "Authorization: token ${GITHUB_TOKEN}" \
             -H "Accept: application/vnd.github.v3+json" \
             https://api.github.com/repos/davegoopot/beemanager-deploy)
        
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | sed '$d')
        
        if [ "$http_code" != "200" ]; then
          echo "ERROR: API request failed with status $http_code"
          echo "Response: $body"
          exit 1
        fi
        
        echo "✓ API authentication successful"
        
        # Extract temp_clone_token if available
        clone_token=$(echo "$body" | jq -r '.temp_clone_token // empty' 2>/dev/null)
        if [ $? -ne 0 ]; then
          echo "WARNING: Failed to parse JSON response, using DEPLOY_TOKEN"
          echo "GIT_TOKEN=${GITHUB_TOKEN}" >> $GITHUB_ENV
        elif [ -n "$clone_token" ]; then
          echo "✓ Found temp_clone_token for git operations"
          echo "GIT_TOKEN=$clone_token" >> $GITHUB_ENV
        else
          echo "No temp_clone_token found, using DEPLOY_TOKEN for git operations"
          echo "GIT_TOKEN=${GITHUB_TOKEN}" >> $GITHUB_ENV
        fi

    - name: Debug - List accessible repos
      run: |
        echo "Checking repos accessible with this token..."
        curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
             -H "Accept: application/vnd.github.v3+json" \
             https://api.github.com/user/repos | jq -r 'if type=="array" then .[].full_name else .  end' | grep -i beemanager || echo "No beemanager repos found"

    - name: Initialize target repository if empty
      run: |
        echo "=== Checking if target repository needs initialization ==="
        
        # Check if repository is empty
        response=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
                       -H "Accept: application/vnd.github.v3+json" \
                       https://api.github.com/repos/davegoopot/beemanager-deploy/git/refs)
        
        if echo "$response" | grep -q "Git Repository is empty"; then
          echo "Repository is empty. Initializing with README..."
          
          # Create initial commit with README using GitHub API
          # Content is base64 encoded: "# beemanager-deploy\n\nThis repository contains deployment files for beemanager."
          curl -X PUT \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/davegoopot/beemanager-deploy/contents/README.md \
            -d '{
              "message": "Initial commit",
              "content": "IyBiZWVtYW5hZ2VyLWRlcGxveQoKVGhpcyByZXBvc2l0b3J5IGNvbnRhaW5zIGRlcGxveW1lbnQgZmlsZXMgZm9yIGJlZW1hbmFnZXIu",
              "branch": "main"
            }'
          
          echo ""
          echo "Repository initialized. Waiting for changes to propagate..."
          sleep 3  # Allow GitHub to process the commit before git operations
        else
          echo "Repository already has commits. Skipping initialization."
        fi
        
    - name: Push to Private Repo
      run: |
        echo "=== Pushing to Private Repository ==="
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        echo "Using GIT_TOKEN for authentication..."
        echo "Adding remote and testing authentication formats..."
        git remote add private-repo https://${GIT_TOKEN}@github.com/davegoopot/beemanager-deploy.git
        
        if git ls-remote private-repo 2>&1; then
          echo "✓ Authentication successful with format: TOKEN@github.com"
        else
          echo "✗ First format failed. Trying x-access-token format..."
          git remote remove private-repo
          git remote add private-repo https://x-access-token:${GIT_TOKEN}@github.com/davegoopot/beemanager-deploy.git
          
          if git ls-remote private-repo 2>&1; then
            echo "✓ Authentication successful with format: x-access-token:TOKEN@github.com"
          else
            echo "✗ Second format failed. Trying x-oauth-basic format..."
            git remote remove private-repo
            git remote add private-repo https://${GIT_TOKEN}:x-oauth-basic@github.com/davegoopot/beemanager-deploy.git
            
            if git ls-remote private-repo 2>&1; then
              echo "✓ Authentication successful with format: TOKEN:x-oauth-basic@github.com"
            else
              echo "✗ All authentication formats failed!"
              echo "This indicates the token may not have the correct permissions for git operations."
              echo "Please verify the token has 'repo' scope and access to private repositories."
              exit 1
            fi
          fi
        fi
        
        echo "Fetching from remote..."
        git fetch private-repo
        
        echo "Pushing HEAD to main (force push to replace any existing content)..."
        git push --force-with-lease private-repo HEAD:main
